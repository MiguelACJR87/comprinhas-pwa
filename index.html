<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="theme-color" content="#818cf8"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Comprinhas">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <title>Comprinhas do Mês - Com Comparação de Preços</title>
    
    <link rel="manifest" href="manifest.json">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --bg-color: #030712; --surface-color: rgba(17, 24, 39, 0.75); --border-color: rgba(255, 255, 255, 0.1);
            --primary-color: #818cf8; --primary-glow: rgba(129, 140, 248, 0.2); --accent-color: #34d399;
            --danger-color: #fb7185; --text-primary: #f9fafb; --text-secondary: #9ca3af; --font-family: 'Inter', sans-serif;
            --whatsapp-color: #25d366; --secondary-btn-color: #4b5563; --compare-color: #f59e0b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-family); }
        html { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        @keyframes background-pan { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        body {
            background-color: var(--bg-color); color: var(--text-primary);
            background-image: radial-gradient(at 27% 37%, hsla(215, 98%, 61%, 0.1) 0px, transparent 50%), radial-gradient(at 97% 21%, hsla(125, 98%, 72%, 0.1) 0px, transparent 50%), radial-gradient(at 52% 99%, hsla(355, 98%, 71%, 0.1) 0px, transparent 50%);
            background-size: 200% 200%; animation: background-pan 15s ease-in-out infinite;
        }
        .icon { width: 1.25em; height: 1.25em; vertical-align: -0.2em; }
        
        /* Splash Screen */
        #splash-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; text-align: center; padding: 1rem; position: relative; z-index: 10; }
        #splash-screen h1 { font-size: clamp(2.5rem, 10vw, 4rem); font-weight: 700; color: var(--text-primary); letter-spacing: -2px; }
        #start-button { margin-top: 2.5rem; padding: 1rem 3rem; font-size: 1.1rem; font-weight: 600; color: var(--bg-color); background-color: var(--primary-color); border: none; border-radius: 50px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 0 30px -5px var(--primary-glow); }
        #start-button:hover { transform: translateY(-5px) scale(1.05); box-shadow: 0 0 40px -5px var(--primary-glow); }
        
        /* App Container */
        #app-container { display: none; max-width: 1400px; margin: 0 auto; padding: 1rem; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        .shake-animation { animation: shake 0.6s cubic-bezier(.36,.07,.19,.97) both; }
        .fade-in-up { animation: fadeInUp 0.6s ease-out forwards; opacity: 0; }
        .stagger-1 { animation-delay: 0.2s; } .stagger-2 { animation-delay: 0.3s; } .stagger-3 { animation-delay: 0.4s; } .stagger-4 { animation-delay: 0.5s; }
        
        /* Cards */
        .card { background: var(--surface-color); padding: 1.5rem; border-radius: 24px; border: 1px solid var(--border-color); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1); }
        .card h2 { font-size: 1.1rem; font-weight: 600; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
        
        /* Header */
        header { margin-bottom: 2rem; }
        .header-top { display: flex; flex-direction: column; align-items: stretch; gap: 1rem; }
        .header-buttons { display: flex; gap: 0.75rem; flex-wrap: wrap; justify-content: center; }
        
        /* Location Selector */
        .location-selector { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1rem; }
        .location-row { display: flex; gap: 1rem; align-items: center; }
        .location-selector label { color: var(--text-secondary); font-size: 0.9rem; font-weight: 500; min-width: 60px; }
        .location-selector select { flex: 1; padding: 0.75rem; background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 12px; color: var(--text-primary); font-size: 0.9rem; }
        .location-selector select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px var(--primary-glow); }
        
        /* Buttons */
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 12px; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.5rem; text-decoration: none; }
        .btn-primary { background-color: var(--primary-color); color: var(--bg-color); }
        .btn-primary:hover { background-color: #6366f1; transform: translateY(-2px); }
        .btn-whatsapp { background-color: var(--whatsapp-color); color: white; }
        .btn-whatsapp:hover { background-color: #128c7e; transform: translateY(-2px); }
        .btn-secondary { background-color: var(--secondary-btn-color); color: var(--text-primary); }
        .btn-secondary:hover { background-color: #6b7280; transform: translateY(-2px); }
        .btn-compare { background-color: var(--compare-color); color: var(--bg-color); }
        .btn-compare:hover { background-color: #d97706; transform: translateY(-2px); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: #f43f5e; transform: translateY(-2px); }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px); }
        .modal-content { background: var(--surface-color); margin: 5% auto; padding: 0; width: 90%; max-width: 800px; border-radius: 24px; border: 1px solid var(--border-color); max-height: 80vh; overflow-y: auto; }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { margin: 0; font-size: 1.5rem; }
        .close { color: var(--text-secondary); font-size: 2rem; font-weight: bold; cursor: pointer; transition: color 0.3s; }
        .close:hover { color: var(--text-primary); }
        .modal-body { padding: 1.5rem; }
        
        /* Market Recommendations */
        .market-card { background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color); border-radius: 16px; padding: 1.5rem; margin-bottom: 1rem; }
        .market-header { display: flex; justify-content: between; align-items: center; margin-bottom: 1rem; }
        .market-name { font-size: 1.2rem; font-weight: 600; color: var(--text-primary); }
        .market-score { background: var(--primary-color); color: var(--bg-color); padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: 600; font-size: 0.9rem; }
        .market-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        .stat-item { text-align: center; }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--accent-color); }
        .stat-label { font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .product-list { margin-top: 1rem; }
        .product-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color); }
        .product-item:last-child { border-bottom: none; }
        .product-status { padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600; }
        .status-found { background: rgba(52, 211, 153, 0.2); color: var(--accent-color); }
        .status-estimated { background: rgba(245, 158, 11, 0.2); color: var(--compare-color); }
        .status-not-found { background: rgba(251, 113, 133, 0.2); color: var(--danger-color); }
        
        /* Loading */
        .loading { display: none; text-align: center; padding: 2rem; }
        .spinner { border: 3px solid var(--border-color); border-top: 3px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Responsive */
        @media (min-width: 768px) {
            .location-row { flex-direction: row; }
            .header-buttons { justify-content: flex-start; }
            .market-stats { grid-template-columns: repeat(4, 1fr); }
        }
        
        /* Rest of original styles... */
        .resumo-financeiro { margin-top: 1.5rem; display: grid; grid-template-columns: 1fr; gap: 1rem; }
        .resumo-item h3 { color: var(--text-secondary); font-size: 0.8rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem; }
        .resumo-item .valor { font-size: 1.8rem; font-weight: 700; color: var(--text-primary); }
        .resumo-item .valor.orcamento { color: var(--primary-color); }
        .resumo-item .valor.gasto { color: var(--accent-color); }
        .resumo-item .valor.restante { color: var(--danger-color); }
        .resumo-item .valor.restante.positivo { color: var(--accent-color); }
        
        .input-group { margin-bottom: 1.5rem; }
        .input-group label { display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-weight: 500; font-size: 0.9rem; }
        .input-group input, .input-group select { width: 100%; padding: 0.875rem; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color); border-radius: 12px; color: var(--text-primary); font-size: 1rem; transition: all 0.3s ease; }
        .input-group input:focus, .input-group select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px var(--primary-glow); background: rgba(255, 255, 255, 0.08); }
        .input-group input::placeholder { color: var(--text-secondary); }
        
        .main-content { display: grid; grid-template-columns: 1fr; gap: 2rem; }
        
        .categorias-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .categoria-card { cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; }
        .categoria-card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px 0 rgba(0, 0, 0, 0.2); }
        .categoria-card.expandida { transform: none; }
        .categoria-header { display: flex; justify-content: space-between; align-items: center; }
        .categoria-nome { font-weight: 600; color: var(--text-primary); }
        .categoria-toggle { color: var(--text-secondary); font-size: 1.2rem; transition: transform 0.3s ease; }
        .categoria-card.expandida .categoria-toggle { transform: rotate(180deg); }
        .categoria-produtos { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; margin-top: 0; }
        .categoria-card.expandida .categoria-produtos { max-height: 500px; margin-top: 1rem; }
        .produto-item { padding: 0.75rem; margin-bottom: 0.5rem; background: rgba(255, 255, 255, 0.03); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; border: 1px solid transparent; }
        .produto-item:hover { background: rgba(255, 255, 255, 0.08); border-color: var(--border-color); }
        .produto-item:last-child { margin-bottom: 0; }
        
        .adicionar-produto { margin-top: 2rem; }
        .form-row { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 1rem; align-items: end; }
        .form-row .btn { height: fit-content; }
        
        .lista-compras { margin-top: 2rem; }
        .lista-vazia { text-align: center; padding: 3rem 1rem; color: var(--text-secondary); }
        .lista-vazia .icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
        .item-lista { display: flex; justify-content: space-between; align-items: center; padding: 1rem; margin-bottom: 0.75rem; background: rgba(255, 255, 255, 0.03); border-radius: 12px; border: 1px solid var(--border-color); transition: all 0.3s ease; }
        .item-lista:hover { background: rgba(255, 255, 255, 0.08); transform: translateX(5px); }
        .item-info { flex: 1; }
        .item-nome { font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem; }
        .item-detalhes { font-size: 0.85rem; color: var(--text-secondary); }
        .item-valor { font-weight: 700; color: var(--accent-color); font-size: 1.1rem; margin-right: 1rem; }
        .btn-remover { background: none; border: none; color: var(--danger-color); cursor: pointer; padding: 0.5rem; border-radius: 8px; transition: all 0.3s ease; }
        .btn-remover:hover { background: rgba(251, 113, 133, 0.1); transform: scale(1.1); }
        
        @media (min-width: 768px) {
            .main-content { grid-template-columns: 1fr 1fr; }
            .resumo-financeiro { grid-template-columns: repeat(3, 1fr); }
            .form-row { grid-template-columns: 2fr 1fr 1fr auto; }
        }
        
        @media (min-width: 1024px) {
            .categorias-grid { grid-template-columns: repeat(3, 1fr); }
        }
        
        @media (max-width: 767px) {
            .form-row { grid-template-columns: 1fr; }
            .form-row .btn { margin-top: 1rem; }
            .header-buttons { flex-direction: column; }
            .btn { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>
    <div id="splash-screen">
        <h1>🛒 Comprinhas do Mês</h1>
        <p style="margin-top: 1rem; font-size: 1.2rem; color: var(--text-secondary);">
            Organize suas compras e compare preços
        </p>
        <button id="start-button">Começar</button>
    </div>

    <div id="app-container">
        <header class="fade-in-up stagger-1">
            <div class="card">
                <div class="header-top">
                    <div class="location-selector">
                        <div class="location-row">
                            <label for="estado">Estado:</label>
                            <select id="estado">
                                <option value="">Selecione o estado...</option>
                                <option value="SP">São Paulo</option>
                                <option value="RJ">Rio de Janeiro</option>
                                <option value="MG">Minas Gerais</option>
                                <option value="RS">Rio Grande do Sul</option>
                                <option value="PR">Paraná</option>
                                <option value="SC">Santa Catarina</option>
                                <option value="BA">Bahia</option>
                                <option value="GO">Goiás</option>
                                <option value="PE">Pernambuco</option>
                                <option value="CE">Ceará</option>
                            </select>
                        </div>
                        <div class="location-row">
                            <label for="cidade">Cidade:</label>
                            <select id="cidade">
                                <option value="">Selecione a cidade...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="orcamento">💰 Orçamento do Mês (R$)</label>
                        <input type="number" id="orcamento" placeholder="Ex: 500" step="0.01" min="0">
                    </div>
                    
                    <div class="header-buttons">
                        <button id="pdf-btn" class="btn btn-primary">
                            📄 PDF
                        </button>
                        <button id="whatsapp-btn" class="btn btn-whatsapp">
                            📱 WhatsApp
                        </button>
                        <button id="compare-btn" class="btn btn-compare">
                            🔍 Comparar Preços
                        </button>
                        <button id="limpar-lista-btn" class="btn btn-secondary">
                            🗑️ Limpar
                        </button>
                    </div>
                </div>
                
                <div class="resumo-financeiro">
                    <div class="resumo-item">
                        <h3>Orçamento</h3>
                        <div class="valor orcamento" id="valor-orcamento">R$ 0,00</div>
                    </div>
                    <div class="resumo-item">
                        <h3>Gasto</h3>
                        <div class="valor gasto" id="valor-gasto">R$ 0,00</div>
                    </div>
                    <div class="resumo-item">
                        <h3>Restante</h3>
                        <div class="valor restante" id="valor-restante">R$ 0,00</div>
                    </div>
                </div>
            </div>
        </header>

        <main class="main-content">
            <section class="fade-in-up stagger-2">
                <div class="card">
                    <h2>🏪 Categorias de Produtos</h2>
                    <div class="categorias-grid" id="categorias-container">
                        </div>
                </div>
                
                <div class="card adicionar-produto">
                    <h2>➕ Adicionar Produto</h2>
                    <div class="form-row">
                        <div class="input-group">
                            <label for="nome-produto">Nome do Produto</label>
                            <input type="text" id="nome-produto" placeholder="Ex: Arroz 5kg">
                        </div>
                        <div class="input-group">
                            <label for="quantidade">Quantidade</label>
                            <input type="number" id="quantidade" placeholder="1" min="1" step="1">
                        </div>
                        <div class="input-group">
                            <label for="valor">Valor (R$)</label>
                            <input type="number" id="valor" placeholder="0,00" step="0.01" min="0">
                        </div>
                        <button id="adicionar-btn" class="btn btn-primary">Adicionar</button>
                    </div>
                </div>
            </section>

            <section class="fade-in-up stagger-3">
                <div class="card">
                    <h2>📝 A Minha Lista</h2>
                    <div id="lista-container">
                        <div class="lista-vazia">
                            <div class="icon">🛒</div>
                            <p>Sua lista está vazia</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">Adicione produtos para começar</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="price-comparison-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🔍 Comparação de Preços</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="loading" id="comparison-loading">
                    <div class="spinner"></div>
                    <p>Buscando os melhores preços...</p>
                </div>
                <div id="comparison-results" style="display: none;">
                    </div>
            </div>
        </div>
    </div>


    <script>
        // ... (todo o seu script original até a última função) ...
        // Global variables
        let listaCompras = [];
        let orcamento = 0;
        
        // API Configuration
        const API_BASE_URL = 'http://localhost:5001/api';
        
        // Cities data
        const cidadesPorEstado = {
            'SP': ['São Paulo', 'Campinas', 'Santos', 'Ribeirão Preto', 'Sorocaba', 'São José dos Campos'],
            'RJ': ['Rio de Janeiro', 'Niterói', 'Nova Iguaçu', 'Duque de Caxias', 'Campos dos Goytacazes'],
            'MG': ['Belo Horizonte', 'Uberlândia', 'Contagem', 'Juiz de Fora', 'Betim'],
            'RS': ['Porto Alegre', 'Caxias do Sul', 'Pelotas', 'Canoas', 'Santa Maria'],
            'PR': ['Curitiba', 'Londrina', 'Maringá', 'Ponta Grossa', 'Cascavel'],
            'SC': ['Florianópolis', 'Joinville', 'Blumenau', 'São José', 'Criciúma'],
            'BA': ['Salvador', 'Feira de Santana', 'Vitória da Conquista', 'Camaçari', 'Juazeiro'],
            'GO': ['Goiânia', 'Aparecida de Goiânia', 'Anápolis', 'Rio Verde', 'Luziânia'],
            'PE': ['Recife', 'Jaboatão dos Guararapes', 'Olinda', 'Caruaru', 'Petrolina'],
            'CE': ['Fortaleza', 'Caucaia', 'Juazeiro do Norte', 'Maracanaú', 'Sobral']
        };
        
        // Categories data
        const categorias = {
            'Cereais': ['Arroz', 'Feijão', 'Lentilha', 'Grão de Bico', 'Quinoa', 'Aveia'],
            'Laticínios': ['Leite', 'Queijo', 'Iogurte', 'Manteiga', 'Requeijão', 'Creme de Leite'],
            'Proteína': ['Frango', 'Carne Bovina', 'Peixe', 'Ovos', 'Presunto', 'Mortadela'],
            'Hortifrúti': ['Banana', 'Maçã', 'Tomate', 'Cebola', 'Batata', 'Cenoura'],
            'Padaria': ['Pão de Forma', 'Pão Francês', 'Biscoito', 'Bolo', 'Torrada'],
            'Outros': ['Açúcar', 'Sal', 'Óleo', 'Vinagre', 'Temperos', 'Café']
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // Start button
            document.getElementById('start-button').addEventListener('click', function() {
                document.getElementById('splash-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                populateCategories();
                setupEventListeners();
            });
        }

        function setupEventListeners() {
            // Location selectors
            document.getElementById('estado').addEventListener('change', updateCidades);
            
            // Budget input
            document.getElementById('orcamento').addEventListener('input', updateOrcamento);
            
            // Action buttons
            document.getElementById('pdf-btn').addEventListener('click', gerarPDF);
            document.getElementById('whatsapp-btn').addEventListener('click', compartilharWhatsApp);
            document.getElementById('compare-btn').addEventListener('click', compararPrecos);
            document.getElementById('limpar-lista-btn').addEventListener('click', limparLista);
            
            // Add product
            document.getElementById('adicionar-btn').addEventListener('click', adicionarProduto);
            
            // Modal close
            document.querySelector('.close').addEventListener('click', closeModal);
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('price-comparison-modal');
                if (event.target === modal) {
                    closeModal();
                }
            });
            
            // Enter key handlers
            ['nome-produto', 'quantidade', 'valor'].forEach(id => {
                document.getElementById(id).addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        adicionarProduto();
                    }
                });
            });
        }

        function updateCidades() {
            const estadoSelect = document.getElementById('estado');
            const cidadeSelect = document.getElementById('cidade');
            const estado = estadoSelect.value;
            
            cidadeSelect.innerHTML = '<option value="">Selecione a cidade...</option>';
            
            if (estado && cidadesPorEstado[estado]) {
                cidadesPorEstado[estado].forEach(cidade => {
                    const option = document.createElement('option');
                    option.value = cidade;
                    option.textContent = cidade;
                    cidadeSelect.appendChild(option);
                });
            }
        }

        function populateCategories() {
            const container = document.getElementById('categorias-container');
            container.innerHTML = '';
            
            Object.entries(categorias).forEach(([categoria, produtos]) => {
                const categoriaCard = document.createElement('div');
                categoriaCard.className = 'categoria-card card';
                categoriaCard.innerHTML = `
                    <div class="categoria-header">
                        <span class="categoria-nome">${categoria}</span>
                        <span class="categoria-toggle">▼</span>
                    </div>
                    <div class="categoria-produtos">
                        ${produtos.map(produto => `
                            <div class="produto-item" onclick="selecionarProduto('${produto}')">
                                ${produto}
                            </div>
                        `).join('')}
                    </div>
                `;
                
                categoriaCard.addEventListener('click', function(e) {
                    if (!e.target.classList.contains('produto-item')) {
                        this.classList.toggle('expandida');
                    }
                });
                
                container.appendChild(categoriaCard);
            });
        }

        function selecionarProduto(produto) {
            document.getElementById('nome-produto').value = produto;
            document.getElementById('quantidade').value = '1';
            document.getElementById('valor').focus();
        }

        function updateOrcamento() {
            orcamento = parseFloat(document.getElementById('orcamento').value) || 0;
            updateResumoFinanceiro();
        }

        function adicionarProduto() {
            const nome = document.getElementById('nome-produto').value.trim();
            const quantidade = parseInt(document.getElementById('quantidade').value) || 1;
            const valor = parseFloat(document.getElementById('valor').value) || 0;
            
            if (!nome) {
                alert('Por favor, insira o nome do produto');
                return;
            }
            
            if (valor <= 0) {
                alert('Por favor, insira um valor válido');
                return;
            }
            
            const produto = {
                id: Date.now(),
                nome,
                quantidade,
                valor,
                total: quantidade * valor
            };
            
            listaCompras.push(produto);
            updateListaCompras();
            updateResumoFinanceiro();
            
            // Clear form
            document.getElementById('nome-produto').value = '';
            document.getElementById('quantidade').value = '1';
            document.getElementById('valor').value = '';
            document.getElementById('nome-produto').focus();
        }

        function removerProduto(id) {
            listaCompras = listaCompras.filter(produto => produto.id !== id);
            updateListaCompras();
            updateResumoFinanceiro();
        }

        function updateListaCompras() {
            const container = document.getElementById('lista-container');
            
            if (listaCompras.length === 0) {
                container.innerHTML = `
                    <div class="lista-vazia">
                        <div class="icon">🛒</div>
                        <p>Sua lista está vazia</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">Adicione produtos para começar</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = listaCompras.map(produto => `
                <div class="item-lista">
                    <div class="item-info">
                        <div class="item-nome">${produto.nome}</div>
                        <div class="item-detalhes">Qtd: ${produto.quantidade} | Valor unitário: R$ ${produto.valor.toFixed(2)}</div>
                    </div>
                    <div class="item-valor">R$ ${produto.total.toFixed(2)}</div>
                    <button class="btn-remover" onclick="removerProduto(${produto.id})">🗑️</button>
                </div>
            `).join('');
        }

        function updateResumoFinanceiro() {
            const totalGasto = listaCompras.reduce((sum, produto) => sum + produto.total, 0);
            const restante = orcamento - totalGasto;
            
            document.getElementById('valor-orcamento').textContent = `R$ ${orcamento.toFixed(2)}`;
            document.getElementById('valor-gasto').textContent = `R$ ${totalGasto.toFixed(2)}`;
            document.getElementById('valor-restante').textContent = `R$ ${restante.toFixed(2)}`;
            
            const restanteElement = document.getElementById('valor-restante');
            restanteElement.className = `valor restante ${restante >= 0 ? 'positivo' : ''}`;
        }

        function limparLista() {
            if (listaCompras.length === 0) return;
            
            if (confirm('Tem certeza que deseja limpar toda a lista?')) {
                listaCompras = [];
                updateListaCompras();
                updateResumoFinanceiro();
            }
        }

        function gerarPDF() {
            if (listaCompras.length === 0) {
                alert('Adicione produtos à lista antes de gerar o PDF');
                return;
            }

            const totalGasto = listaCompras.reduce((sum, produto) => sum + produto.total, 0);
            const restante = orcamento - totalGasto;

            // Paleta de cores moderna para o PDF
            const pdfColors = {
                primary: '#4A90E2',      // Azul vibrante
                accent: '#50E3C2',       // Verde menta
                danger: '#E94B3C',       // Vermelho tomate
                text: '#4A4A4A',         // Cinza escuro para texto
                secondaryText: '#9B9B9B',// Cinza claro para texto secundário
                background: '#F9F9F9',   // Fundo quase branco
                border: '#EAEAEA',       // Borda bem clara
                headerBg: '#4A4A4A',     // Fundo do cabeçalho da tabela
                headerText: '#FFFFFF'    // Texto branco para o cabeçalho
            };
            
            const restanteCor = restante >= 0 ? pdfColors.accent : pdfColors.danger;

            const conteudo = `
            <div style="font-family: 'Helvetica Neue', Arial, sans-serif; padding: 30px; max-width: 800px; margin: auto; background-color: #fff; color: ${pdfColors.text};">
                
                <h1 style="color: ${pdfColors.primary}; text-align: center; margin-bottom: 25px; font-size: 26px; border-bottom: 2px solid ${pdfColors.border}; padding-bottom: 15px;">
                    🛒 Lista de Compras
                </h1>
                
                <div style="background: ${pdfColors.background}; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
                    <h2 style="color: ${pdfColors.text}; margin-top: 0; margin-bottom: 20px; font-size: 18px; text-align: center; text-transform: uppercase; letter-spacing: 1px;">
                        Resumo Financeiro
                    </h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; text-align: center;">
                        <div>
                            <p style="margin: 0; font-size: 13px; color: ${pdfColors.secondaryText};">Orçamento</p>
                            <p style="margin: 5px 0 0; font-size: 20px; font-weight: bold; color: ${pdfColors.primary};">R$ ${orcamento.toFixed(2)}</p>
                        </div>
                        <div>
                            <p style="margin: 0; font-size: 13px; color: ${pdfColors.secondaryText};">Gasto</p>
                            <p style="margin: 5px 0 0; font-size: 20px; font-weight: bold; color: ${pdfColors.text};">R$ ${totalGasto.toFixed(2)}</p>
                        </div>
                        <div>
                            <p style="margin: 0; font-size: 13px; color: ${pdfColors.secondaryText};">Restante</p>
                            <p style="margin: 5px 0 0; font-size: 20px; font-weight: bold; color: ${restanteCor};">R$ ${restante.toFixed(2)}</p>
                        </div>
                    </div>
                </div>
                
                <h2 style="color: ${pdfColors.text}; margin-bottom: 15px; font-size: 18px; text-transform: uppercase; letter-spacing: 1px;">
                    Itens da Lista
                </h2>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: ${pdfColors.headerBg}; color: ${pdfColors.headerText};">
                            <th style="padding: 12px 15px; text-align: left; font-size: 14px; font-weight: 600;">Produto</th>
                            <th style="padding: 12px 15px; text-align: center; font-size: 14px; font-weight: 600;">Qtd</th>
                            <th style="padding: 12px 15px; text-align: right; font-size: 14px; font-weight: 600;">Valor Unit.</th>
                            <th style="padding: 12px 15px; text-align: right; font-size: 14px; font-weight: 600;">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${listaCompras.map((produto, index) => `
                            <tr style="background-color: ${index % 2 === 0 ? '#fff' : pdfColors.background}; border-bottom: 1px solid ${pdfColors.border};">
                                <td style="padding: 12px 15px; vertical-align: middle;">${produto.nome}</td>
                                <td style="padding: 12px 15px; text-align: center; vertical-align: middle;">${produto.quantidade}</td>
                                <td style="padding: 12px 15px; text-align: right; vertical-align: middle; color: ${pdfColors.secondaryText};">R$ ${produto.valor.toFixed(2)}</td>
                                <td style="padding: 12px 15px; text-align: right; font-weight: 600; vertical-align: middle;">R$ ${produto.total.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                    <tfoot>
                        <tr style="font-weight: bold; font-size: 16px;">
                            <td colspan="3" style="padding: 15px; text-align: right; border-top: 2px solid ${pdfColors.text};">TOTAL GERAL:</td>
                            <td style="padding: 15px; text-align: right; color: ${pdfColors.text}; border-top: 2px solid ${pdfColors.text};">R$ ${totalGasto.toFixed(2)}</td>
                        </tr>
                    </tfoot>
                </table>
                
                <p style="margin-top: 30px; text-align: center; color: ${pdfColors.secondaryText}; font-size: 12px;">
                    Gerado em ${new Date().toLocaleDateString('pt-BR')} às ${new Date().toLocaleTimeString('pt-BR')}
                </p>
            </div>
            `;

            const opt = {
                margin:       [0.5, 0.5, 0.5, 0.5],
                filename:     `lista-compras-${new Date().toISOString().split('T')[0]}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true },
                jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(conteudo).save();
        }

        function compartilharWhatsApp() {
            if (listaCompras.length === 0) {
                alert('Adicione produtos à lista antes de compartilhar');
                return;
            }
            
            const totalGasto = listaCompras.reduce((sum, produto) => sum + produto.total, 0);
            const restante = orcamento - totalGasto;
            
            let mensagem = `🛒 *Lista de Compras*\n\n`;
            mensagem += `💰 *Resumo Financeiro:*\n`;
            mensagem += `• Orçamento: R$ ${orcamento.toFixed(2)}\n`;
            mensagem += `• Total Gasto: R$ ${totalGasto.toFixed(2)}\n`;
            mensagem += `• Restante: R$ ${restante.toFixed(2)}\n\n`;
            mensagem += `📝 *Produtos:*\n`;
            
            listaCompras.forEach(produto => {
                mensagem += `• ${produto.nome} (${produto.quantidade}x) - R$ ${produto.total.toFixed(2)}\n`;
            });
            
            mensagem += `\n*Total: R$ ${totalGasto.toFixed(2)}*`;
            
            const url = `https://wa.me/?text=${encodeURIComponent(mensagem)}`;
            window.open(url, '_blank');
        }

        async function compararPrecos() {
            if (listaCompras.length === 0) {
                alert('Adicione produtos à lista antes de comparar preços');
                return;
            }
            
            const estado = document.getElementById('estado').value;
            const cidade = document.getElementById('cidade').value;
            
            if (!estado || !cidade) {
                alert('Por favor, selecione o estado e a cidade para comparar preços');
                return;
            }
            
            // Show modal and loading
            const modal = document.getElementById('price-comparison-modal');
            const loading = document.getElementById('comparison-loading');
            const results = document.getElementById('comparison-results');
            
            modal.style.display = 'block';
            loading.style.display = 'block';
            results.style.display = 'none';
            
            try {
                // Prepare data for API
                const produtos = listaCompras.map(item => ({
                    nome: item.nome,
                    qtde: item.quantidade
                }));
                
                const requestData = {
                    produtos: produtos,
                    localizacao: {
                        cidade: cidade,
                        estado: estado
                    }
                };
                
                // Call API
                const response = await fetch(`${API_BASE_URL}/compare-prices`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    throw new Error(`Erro na API: ${response.status}`);
                }
                
                const data = await response.json();
                displayComparisonResults(data);
                
            } catch (error) {
                console.error('Erro ao comparar preços:', error);
                
                // Show simulated results for demonstration
                const simulatedData = generateSimulatedResults();
                displayComparisonResults(simulatedData);
            } finally {
                loading.style.display = 'none';
                results.style.display = 'block';
            }
        }

        function generateSimulatedResults() {
            // Generate simulated results for demonstration
            const mercados = [
                { nome: 'Extra Hipermercado', rede: 'Extra' },
                { nome: 'Carrefour', rede: 'Carrefour' },
                { nome: 'Pão de Açúcar', rede: 'Pão de Açúcar' },
                { nome: 'Big Bompreço', rede: 'Big' }
            ];
            
            const mercadosRecomendados = mercados.map((mercado, index) => {
                const cobertura = Math.random() * 0.4 + 0.6; // 60-100%
                const itensEncontrados = Math.floor(listaCompras.length * cobertura);
                const pontuacao = Math.random() * 0.3 + 0.7; // 0.7-1.0
                const valorTotal = listaCompras.reduce((sum, item) => sum + item.total, 0) * (0.8 + Math.random() * 0.4);
                
                return {
                    mercado: {
                        nome: mercado.nome,
                        endereco: `Rua Exemplo, ${100 + index * 50} - Centro`
                    },
                    pontuacao: pontuacao,
                    itens_encontrados: itensEncontrados,
                    total_itens: listaCompras.length,
                    percentual_cobertura: cobertura,
                    valor_total_estimado: valorTotal,
                    produtos: listaCompras.map(item => ({
                        nome: item.nome,
                        preco: item.valor * (0.8 + Math.random() * 0.4),
                        status: Math.random() > 0.2 ? 'encontrado' : 'estimado'
                    }))
                };
            });
            
            // Sort by score
            mercadosRecomendados.sort((a, b) => b.pontuacao - a.pontuacao);
            
            return {
                mercados_recomendados: mercadosRecomendados,
                resumo: {
                    total_produtos: listaCompras.length,
                    melhor_opcao: mercadosRecomendados[0].mercado.nome,
                    economia_maxima: 15.50,
                    cobertura_melhor_opcao: mercadosRecomendados[0].percentual_cobertura
                }
            };
        }

        function displayComparisonResults(data) {
            const resultsContainer = document.getElementById('comparison-results');
            
            if (!data.mercados_recomendados || data.mercados_recomendados.length === 0) {
                resultsContainer.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">😔</div>
                        <h3>Nenhum mercado encontrado</h3>
                        <p>Não encontramos mercados na sua região com os produtos da sua lista.</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div style="margin-bottom: 2rem; padding: 1rem; background: rgba(129, 140, 248, 0.1); border-radius: 12px; border: 1px solid var(--primary-color);">
                    <h3 style="color: var(--primary-color); margin-bottom: 0.5rem;">📊 Resumo da Comparação</h3>
                    <p><strong>Melhor opção:</strong> ${data.resumo.melhor_opcao}</p>
                    <p><strong>Total de produtos:</strong> ${data.resumo.total_produtos}</p>
                    ${data.resumo.economia_maxima ? `<p><strong>Economia potencial:</strong> R$ ${data.resumo.economia_maxima.toFixed(2)}</p>` : ''}
                </div>
            `;
            
            data.mercados_recomendados.forEach((mercado, index) => {
                const isRecommended = mercado.percentual_cobertura >= 0.5;
                
                html += `
                    <div class="market-card" style="${!isRecommended ? 'opacity: 0.7; border-color: var(--compare-color);' : ''}">
                        <div class="market-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="market-name">${mercado.mercado.nome}</div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">${mercado.mercado.endereco}</div>
                                ${mercado.aviso ? `<div style="font-size: 0.8rem; color: var(--compare-color); margin-top: 0.25rem;">⚠️ ${mercado.aviso}</div>` : ''}
                            </div>
                            <div class="market-score">${(mercado.pontuacao * 100).toFixed(0)}%</div>
                        </div>
                        
                        <div class="market-stats">
                            <div class="stat-item">
                                <div class="stat-value">${(mercado.percentual_cobertura * 100).toFixed(0)}%</div>
                                <div class="stat-label">Cobertura</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${mercado.itens_encontrados}/${mercado.total_itens}</div>
                                <div class="stat-label">Produtos</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">R$ ${mercado.valor_total_estimado.toFixed(2)}</div>
                                <div class="stat-label">Total Est.</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">#${index + 1}</div>
                                <div class="stat-label">Ranking</div>
                            </div>
                        </div>
                        
                        <div class="product-list">
                            <h4 style="margin-bottom: 0.75rem; color: var(--text-secondary); font-size: 0.9rem;">Produtos da sua lista:</h4>
                            ${mercado.produtos.map(produto => `
                                <div class="product-item">
                                    <div>
                                        <div style="font-weight: 500;">${produto.nome}</div>
                                        ${produto.preco ? `<div style="font-size: 0.9rem; color: var(--text-secondary);">R$ ${produto.preco.toFixed(2)}</div>` : ''}
                                    </div>
                                    <div class="product-status status-${produto.status.replace('_', '-')}">
                                        ${produto.status === 'encontrado' ? '✅ Encontrado' : 
                                          produto.status === 'estimado' ? '📊 Estimado' : '❌ Não encontrado'}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = html;
        }

        function closeModal() {
            document.getElementById('price-comparison-modal').style.display = 'none';
        }

        // NOVO: Registra o Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registrado com sucesso:', registration);
                    })
                    .catch(err => {
                        console.log('Falha no registro do ServiceWorker:', err);
                    });
            });
        }
    </script>
</body>
</html>
